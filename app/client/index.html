<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SyncPit - Draw Together, No Bullshit</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Special+Elite&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #000;
      color: #fff;
      font-family: 'Special Elite', 'Courier New', monospace;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      width: 100%;
    }

    header {
      text-align: center;
      margin-bottom: 60px;
      margin-top: 60px;
      min-height: 50vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      position: relative;
    }

    h1 {
      font-size: min(12vw, 260px);
      font-weight: bold;
      letter-spacing: 0.1em;
      margin-bottom: 20px;
      text-transform: uppercase;
      line-height: 0.9;
      text-shadow:
        -3px 0 0 rgba(255, 0, 0, 0.8),
        3px 0 0 rgba(0, 255, 255, 0.8);
      padding: 0 60px;
    }

    .tagline {
      font-size: 1.5rem;
      color: #fff;
      margin-top: 20px;
      font-weight: bold;
    }

    .info-btn {
      position: absolute;
      top: 0;
      right: 0;
      background: transparent;
      color: #fff;
      border: 2px solid #fff;
      width: 40px;
      height: 40px;
      font-size: 1.5rem;
      cursor: pointer;
      font-family: 'Special Elite', monospace;
      transition: all 0.1s;
    }

    .info-btn:hover {
      background: #fff;
      color: #000;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: #000;
      border: 3px solid #fff;
      padding: 40px;
      max-width: 600px;
      width: 100%;
      position: relative;
    }

    .modal-close {
      position: absolute;
      top: 10px;
      right: 10px;
      background: transparent;
      color: #fff;
      border: 2px solid #fff;
      width: 40px;
      height: 40px;
      font-size: 1.5rem;
      cursor: pointer;
      font-family: 'Special Elite', monospace;
    }

    .modal-close:hover {
      background: #fff;
      color: #000;
    }

    .manifesto {
      font-size: 1.1rem;
      line-height: 1.8;
    }

    .manifesto p {
      margin-bottom: 15px;
    }

    .actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 50px;
    }

    .action-box {
      background: #111;
      border: 3px solid #fff;
      padding: 40px 30px;
      text-align: center;
      transition: all 0.1s;
      cursor: pointer;
    }

    .action-box:hover {
      background: #fff;
      color: #000;
      transform: translate(-2px, -2px);
      box-shadow: 4px 4px 0 #666;
    }

    .action-box h2 {
      font-size: 2rem;
      margin-bottom: 15px;
      text-transform: uppercase;
    }

    .action-box p {
      font-size: 0.9rem;
      margin-bottom: 20px;
      color: #999;
    }

    .action-box:hover p {
      color: #666;
    }

    .action-box button {
      background: transparent;
      color: inherit;
      border: 2px solid currentColor;
      padding: 12px 30px;
      font-family: 'Special Elite', monospace;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      text-transform: uppercase;
      transition: all 0.1s;
    }

    .action-box:hover button {
      background: #000;
      color: #fff;
    }

    .jump-form {
      display: none;
      margin-top: 20px;
    }

    .jump-form.active {
      display: block;
    }

    .jump-form-row {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }

    .jump-form input {
      background: #000;
      color: #fff;
      border: 2px solid #fff;
      padding: 10px;
      font-family: 'Special Elite', monospace;
      font-size: 1rem;
      flex: 1;
    }

    .action-box:hover .jump-form input {
      background: #fff;
      color: #000;
      border-color: #000;
    }

    .scan-qr-btn {
      background: transparent;
      color: #fff;
      border: 2px solid #fff;
      height: 44px;
      width: 50px;
      cursor: pointer;
      padding: 0;
      font-family: 'Special Elite', monospace;
      font-size: 0.65rem;
      font-weight: bold;
      transition: all 0.1s;
      line-height: 1.3;
      white-space: nowrap;
      display: flex;
      align-items: center;
      justify-content: center;
      padding-top: 5px;
    }

    .scan-qr-btn:hover {
      background: #fff;
      color: #000;
    }

    .action-box:hover .scan-qr-btn {
      background: #fff;
      color: #000;
      border-color: #000;
    }

    footer {
      margin-top: auto;
      text-align: center;
      font-size: 0.85rem;
      color: #666;
      padding-top: 50px;
      border-top: 1px solid #333;
    }

    #qr-reader {
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
    }

    #qr-reader video {
      width: 100%;
      border: 3px solid #fff;
    }

    .scanner-status {
      text-align: center;
      margin-top: 20px;
      color: #0ff;
      font-size: 0.9rem;
    }

    @media (max-width: 768px) {
      h1 {
        font-size: 18vw;
      }

      .tagline {
        font-size: 1.2rem;
      }

      .actions {
        grid-template-columns: 1fr;
        gap: 20px;
      }

      .modal-content {
        padding: 30px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <button class="info-btn" onclick="openModal()">?</button>
      <h1>SYNC<br>PIT</h1>
      <div class="tagline">Draw fast. Sync faster. Bail whenever.</div>
    </header>

    <div class="actions">
      <div class="action-box" onclick="createPit()">
        <h2>Create a Pit</h2>
        <p>Start fresh. Get a link. Share it.</p>
        <button>CREATE</button>
      </div>

      <div class="action-box">
        <div onclick="toggleJumpForm()">
          <h2>Jump In</h2>
          <p>Got a pit code? Enter it here.</p>
          <button id="jump-btn">JUMP</button>
        </div>
        <div class="jump-form" id="jump-form" onclick="event.stopPropagation()">
          <div class="jump-form-row">
            <input
              type="text"
              id="pit-code"
              placeholder="Enter pit code..."
              onkeypress="if(event.key==='Enter') jumpToPit()"
            >
            <button class="scan-qr-btn" onclick="openQRScanner(event)" title="Scan QR Code">SCAN<br>CODE</button>
          </div>
          <button onclick="jumpToPit()" style="width: 100%;">GO</button>
        </div>
      </div>
    </div>

    <footer>
      <p>Built with Yjs. Runs on Node. Hosted wherever.</p>
      <p>Source: <a href="https://github.com/zorlack/SyncPit" style="color: #666;">github.com/zorlack/SyncPit</a></p>
      <p id="version-info" style="color: #444; font-size: 0.75rem; margin-top: 10px;"></p>
    </footer>
  </div>

  <div class="modal" id="info-modal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeModal()">×</button>
      <div class="manifesto">
        <p><strong>THIS IS NOT A PRODUCT.</strong> This is a tool.</p>
        <p>We're not here to optimize your engagement or harvest your data. We're here because sometimes you need to draw something with someone else, right now, without signing up for anything or downloading an app.</p>
        <p>Create a pit. Share the link. Draw. That's it.</p>
        <p>Your pit lives for 30 minutes after the last person leaves. Then it's gone. Forever. Who cares.</p>
      </div>
    </div>
  </div>

  <div class="modal" id="qr-scanner-modal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeQRScanner()">×</button>
      <h2 style="text-transform: uppercase; margin-bottom: 20px;">Scan QR Code</h2>
      <div id="qr-reader"></div>
      <div class="scanner-status" id="scanner-status">Point camera at QR code...</div>
    </div>
  </div>

  <script type="module">
    import { Html5Qrcode } from 'html5-qrcode';

    // Display version
    document.getElementById('version-info').textContent = `v${__APP_VERSION__}`;

    let html5QrCode = null;

    window.createPit = function() {
      // Generate a random pit slug
      const slug = Math.random().toString(36).substring(2, 10);
      window.location.href = `/pit/${slug}/creator`;
    };

    window.toggleJumpForm = function() {
      const form = document.getElementById('jump-form');
      const btn = document.getElementById('jump-btn');

      if (form.classList.contains('active')) {
        form.classList.remove('active');
        btn.textContent = 'JUMP';
      } else {
        form.classList.add('active');
        btn.textContent = 'CANCEL';
        setTimeout(() => document.getElementById('pit-code').focus(), 100);
      }
    };

    window.jumpToPit = function() {
      const code = document.getElementById('pit-code').value.trim();
      if (code) {
        window.location.href = `/pit/${code}/creator`;
      }
    };

    window.openQRScanner = async function(event) {
      if (event) {
        event.stopPropagation();
      }

      const modal = document.getElementById('qr-scanner-modal');
      const status = document.getElementById('scanner-status');

      modal.classList.add('active');
      status.textContent = 'Starting camera...';

      try {
        html5QrCode = new Html5Qrcode('qr-reader');

        await html5QrCode.start(
          { facingMode: 'environment' }, // Use back camera
          {
            fps: 10,
            qrbox: { width: 250, height: 250 }
          },
          (decodedText) => {
            // QR code found!
            status.textContent = 'QR Code found!';

            // Extract pit code from URL
            // Supports: /pit/ABC123/creator, /pit/ABC123/viewer, or just ABC123
            let pitCode = null;

            try {
              const url = new URL(decodedText);
              const match = url.pathname.match(/\/pit\/([^\/]+)/);
              if (match) {
                pitCode = match[1];
              }
            } catch {
              // Not a valid URL, maybe just the pit code
              pitCode = decodedText.trim();
            }

            if (pitCode) {
              closeQRScanner();
              window.location.href = `/pit/${pitCode}/creator`;
            } else {
              status.textContent = 'Not a valid SyncPit QR code';
            }
          },
          (errorMessage) => {
            // Scanning (no QR code in view)
            status.textContent = 'Point camera at QR code...';
          }
        );
      } catch (err) {
        console.error('Failed to start QR scanner:', err);
        status.textContent = 'Failed to access camera. Please check permissions.';
      }
    };

    window.closeQRScanner = async function() {
      const modal = document.getElementById('qr-scanner-modal');
      const status = document.getElementById('scanner-status');

      if (html5QrCode) {
        try {
          await html5QrCode.stop();
          html5QrCode = null;
        } catch (err) {
          console.error('Failed to stop QR scanner:', err);
        }
      }

      modal.classList.remove('active');
      status.textContent = 'Point camera at QR code...';
    };

    window.openModal = function() {
      document.getElementById('info-modal').classList.add('active');
    };

    window.closeModal = function() {
      document.getElementById('info-modal').classList.remove('active');
    };

    // Close modals when clicking outside
    document.getElementById('info-modal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeModal();
      }
    });

    document.getElementById('qr-scanner-modal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeQRScanner();
      }
    });

    // Close modals with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeModal();
        closeQRScanner();
      }
    });
  </script>
</body>
</html>
