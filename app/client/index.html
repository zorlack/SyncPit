<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SyncPit - Draw Together, No Bullshit</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Special+Elite&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #000;
      color: #fff;
      font-family: 'Special Elite', 'Courier New', monospace;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      width: 100%;
    }

    header {
      text-align: center;
      margin-bottom: 60px;
      margin-top: 60px;
      min-height: 50vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      position: relative;
    }

    h1 {
      font-size: min(12vw, 260px);
      font-weight: bold;
      letter-spacing: 0.1em;
      margin-bottom: 20px;
      text-transform: uppercase;
      line-height: 0.9;
      text-shadow:
        -3px 0 0 rgba(255, 0, 0, 0.8),
        3px 0 0 rgba(0, 255, 255, 0.8);
      padding: 0 60px;
      cursor: pointer;
      user-select: none;
      transition: opacity 0.1s, transform 0.1s, filter 0.1s;
      transform-origin: center center;
    }

    h1:hover {
      opacity: 0.8;
    }

    h1.playing {
      cursor: alias;
    }

    h1.animating {
      transition: transform 0.1s ease-out, filter 0.1s ease-out, opacity 0.1s ease-out;
    }

    .tagline {
      font-size: 1.5rem;
      color: #fff;
      margin-top: 20px;
      font-weight: bold;
    }

    .info-btn {
      position: absolute;
      top: 0;
      right: 0;
      background: transparent;
      color: #fff;
      border: 2px solid #fff;
      width: 40px;
      height: 40px;
      font-size: 1.5rem;
      cursor: pointer;
      font-family: 'Special Elite', monospace;
      transition: all 0.1s;
    }

    .info-btn:hover {
      background: #fff;
      color: #000;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: #000;
      border: 3px solid #fff;
      padding: 40px;
      max-width: 600px;
      width: 100%;
      position: relative;
    }

    .modal-close {
      position: absolute;
      top: 10px;
      right: 10px;
      background: transparent;
      color: #fff;
      border: 2px solid #fff;
      width: 40px;
      height: 40px;
      font-size: 1.5rem;
      cursor: pointer;
      font-family: 'Special Elite', monospace;
    }

    .modal-close:hover {
      background: #fff;
      color: #000;
    }

    .manifesto {
      font-size: 1.1rem;
      line-height: 1.8;
    }

    .manifesto p {
      margin-bottom: 15px;
    }

    .actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 50px;
    }

    .action-box {
      background: #111;
      border: 3px solid #fff;
      padding: 40px 30px;
      text-align: center;
      transition: all 0.1s;
      cursor: pointer;
    }

    .action-box:hover {
      background: #fff;
      color: #000;
      transform: translate(-2px, -2px);
      box-shadow: 4px 4px 0 #666;
    }

    .action-box h2 {
      font-size: 2rem;
      margin-bottom: 15px;
      text-transform: uppercase;
    }

    .action-box p {
      font-size: 0.9rem;
      margin-bottom: 20px;
      color: #999;
    }

    .action-box:hover p {
      color: #666;
    }

    .action-box button:not(.qr-icon-btn) {
      background: transparent;
      color: inherit;
      border: 2px solid currentColor;
      padding: 12px 30px;
      font-family: 'Special Elite', monospace;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      text-transform: uppercase;
      transition: all 0.1s;
    }

    .action-box:hover button:not(.qr-icon-btn) {
      background: #000;
      color: #fff;
    }

    .jump-form-row {
      display: flex;
      gap: 8px;
      margin-top: 20px;
    }

    .input-with-icon {
      position: relative;
      flex: 1;
      display: flex;
      align-items: center;
    }

    .input-with-icon input {
      background: #000;
      color: #fff;
      border: 2px solid #fff;
      padding: 14px 36px 10px 10px;
      font-family: 'Special Elite', monospace;
      font-size: 1rem;
      width: 100%;
      line-height: 1.2;
    }

    .action-box:hover .input-with-icon input {
      background: #fff;
      color: #000;
      border-color: #000;
    }

    .qr-icon-btn {
      position: absolute;
      right: 4px;
      top: 50%;
      transform: translateY(-50%);
      background: transparent !important;
      color: #666;
      border: none !important;
      outline: none !important;
      height: 30px;
      width: 30px;
      cursor: pointer;
      padding: 2px;
      margin: 0;
      transition: color 0.1s;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .qr-icon-btn svg {
      width: 20px;
      height: 20px;
      display: block;
      flex-shrink: 0;
    }

    .qr-icon-btn:hover {
      color: #fff !important;
      background: transparent !important;
      border: none !important;
    }

    .qr-icon-btn:focus {
      outline: none !important;
      border: none !important;
    }

    .qr-icon-btn:active {
      outline: none !important;
      border: none !important;
    }

    .action-box:hover .qr-icon-btn {
      color: #666;
    }

    .action-box:hover .qr-icon-btn:hover {
      color: #000 !important;
    }

    .go-btn {
      background: transparent;
      color: #fff;
      border: 2px solid #fff;
      padding: 10px 20px;
      cursor: pointer;
      font-family: 'Special Elite', monospace;
      font-size: 1rem;
      font-weight: bold;
      transition: all 0.1s;
      white-space: nowrap;
    }

    .go-btn:hover {
      background: #fff;
      color: #000;
    }

    .action-box:hover .go-btn {
      background: #fff;
      color: #000;
      border-color: #000;
    }

    footer {
      margin-top: auto;
      text-align: center;
      font-size: 0.85rem;
      color: #666;
      padding-top: 50px;
      border-top: 1px solid #333;
    }

    #qr-reader {
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
    }

    #qr-reader video {
      width: 100%;
      border: 3px solid #fff;
    }

    .scanner-status {
      text-align: center;
      margin-top: 20px;
      color: #0ff;
      font-size: 0.9rem;
    }

    @media (max-width: 768px) {
      h1 {
        font-size: 18vw;
      }

      .tagline {
        font-size: 1.2rem;
      }

      .actions {
        grid-template-columns: 1fr;
        gap: 20px;
      }

      .modal-content {
        padding: 30px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <button class="info-btn" onclick="openModal()">?</button>
      <h1 id="logo" onclick="toggleMusic()">SYNC<br>PIT</h1>
      <audio id="welcomeMusic" src="/SYNC_PIT.mp3" preload="auto"></audio>
      <div class="tagline">Draw fast. Sync faster. Bail whenever.</div>
    </header>

    <div class="actions">
      <div class="action-box" onclick="createPit()">
        <h2>Create a Pit</h2>
        <p>Start fresh. Get a link. Share it.</p>
        <button>CREATE</button>
      </div>

      <div class="action-box">
        <h2>Jump In</h2>
        <p>Got a pit code? Enter it here.</p>
        <div class="jump-form-row">
          <div class="input-with-icon">
            <input
              type="text"
              id="pit-code"
              placeholder="Enter pit code..."
              onkeypress="if(event.key==='Enter') jumpToPit()"
            >
            <button class="qr-icon-btn" onclick="openQRScanner(event)" title="Scan QR Code" type="button">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                <circle cx="12" cy="13" r="4"/>
              </svg>
            </button>
          </div>
          <button onclick="jumpToPit()" class="go-btn">GO</button>
        </div>
      </div>
    </div>

    <footer>
      <p>Built with Yjs. Runs on Node. Hosted wherever.</p>
      <p>Source: <a href="https://github.com/zorlack/SyncPit" style="color: #666;">github.com/zorlack/SyncPit</a></p>
      <p id="version-info" style="color: #444; font-size: 0.75rem; margin-top: 10px;"></p>
    </footer>
  </div>

  <div class="modal" id="info-modal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeModal()">×</button>
      <div class="manifesto">
        <p><strong>THIS IS NOT A PRODUCT.</strong> This is a tool.</p>
        <p>We're not here to optimize your engagement or harvest your data. We're here because sometimes you need to draw something with someone else, right now, without signing up for anything or downloading an app.</p>
        <p>Create a pit. Share the link. Draw. That's it.</p>
        <p>Your pit lives for 30 minutes after the last person leaves. Then it's gone. Forever. Who cares.</p>
      </div>
    </div>
  </div>

  <div class="modal" id="qr-scanner-modal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeQRScanner()">×</button>
      <h2 style="text-transform: uppercase; margin-bottom: 20px;">Scan QR Code</h2>
      <div id="qr-reader"></div>
      <div class="scanner-status" id="scanner-status">Point camera at QR code...</div>
    </div>
  </div>

  <script type="module">
    import { Html5Qrcode } from 'html5-qrcode';

    // Display version
    document.getElementById('version-info').textContent = `v${__APP_VERSION__}`;

    let html5QrCode = null;
    let loudnessData = null;
    let animationFrame = null;
    let lastSampleIndex = -1;
    let resetTimeout = null;

    // Load loudness data
    fetch('/SYNC_PIT_loudness.json')
      .then(res => res.json())
      .then(data => {
        loudnessData = data;
        console.log('Loaded loudness data:', data.metadata.samples, 'samples');
      })
      .catch(err => console.error('Failed to load loudness data:', err));

    // Apply animation state
    function applyLogoAnimation(intensity) {
      const logo = document.getElementById('logo');

      if (intensity === 0) {
        // Neutral state
        logo.style.transform = '';
        logo.style.textShadow = `
          -3px 0 0 rgba(255, 0, 0, 0.8),
          3px 0 0 rgba(0, 255, 255, 0.8)
        `;
        logo.style.opacity = '';
        return;
      }

      // Calculate variations based on loudness
      // Scale: contract at low volumes (0.975), expand at high volumes (1.025)
      const scaleVariation = 0.975 + (intensity * 0.05);
      const opacityVariation = 0.95 + (intensity * 0.05); // 95% to 100% opacity
      const rotationVariation = (intensity - 0.5) * 2; // -1 to 1 degrees
      const chromaticOffset = Math.floor(intensity * 5); // 0 to 5px chromatic aberration

      // Apply transformations
      logo.style.transform = `scale(${scaleVariation}) rotate(${rotationVariation}deg)`;
      logo.style.opacity = opacityVariation;
      logo.style.textShadow = `
        ${-3 - chromaticOffset}px 0 0 rgba(255, 0, 0, ${0.8 * intensity}),
        ${3 + chromaticOffset}px 0 0 rgba(0, 255, 255, ${0.8 * intensity})
      `;
    }

    // Animation controller
    function animateLogo() {
      const audio = document.getElementById('welcomeMusic');
      const logo = document.getElementById('logo');

      if (!loudnessData || audio.paused || audio.ended) {
        // Reset to neutral position when stopped
        if (resetTimeout) {
          clearTimeout(resetTimeout);
          resetTimeout = null;
        }
        applyLogoAnimation(0);
        logo.classList.remove('animating');
        lastSampleIndex = -1;
        return;
      }

      logo.classList.add('animating');

      const currentTime = audio.currentTime * 1000; // Convert to milliseconds
      const sampleInterval = loudnessData.metadata.intervalMs;
      const halfInterval = sampleInterval / 2;

      // Find the closest sample by searching through timestamps
      let currentSampleIndex = 0;
      let minDiff = Math.abs(currentTime - loudnessData.loudness[0].time);

      for (let i = 1; i < loudnessData.loudness.length; i++) {
        const diff = Math.abs(currentTime - loudnessData.loudness[i].time);
        if (diff < minDiff) {
          minDiff = diff;
          currentSampleIndex = i;
        } else {
          // Times are increasing, so we can break early
          break;
        }
      }

      // Check if we're on a new sample
      if (currentSampleIndex !== lastSampleIndex) {
        lastSampleIndex = currentSampleIndex;
        const sample = loudnessData.loudness[currentSampleIndex];

        // Apply exponential curve to reduce motion at lower levels
        let rawIntensity = sample.normalized;

        // Special emphasis for key moments - wider windows to ensure we catch them
        const time = sample.time;
        if ((time >= 830 && time <= 900) || (time >= 1840 && time <= 1910)) {
          // Boost intensity dramatically for these moments
          rawIntensity = 3.0; // Way beyond normal range for massive impact
        }

        // Fade out starting 5 seconds before the end as the music fades
        let intensity = Math.pow(rawIntensity, 2.5);
        const fadeStartTime = (loudnessData.metadata.duration - 5) * 1000; // 5 seconds before end
        if (time >= fadeStartTime) {
          // Calculate fade factor (1.0 at start of fade, approaching 0 by end)
          const fadeProgress = (time - fadeStartTime) / 5000; // Fade over 5 seconds
          const fadeFactor = 1.0 - fadeProgress;
          intensity *= fadeFactor;
        }

        // Pulse out to animated state
        applyLogoAnimation(intensity);

        // Clear any pending reset
        if (resetTimeout) {
          clearTimeout(resetTimeout);
        }

        // Return to neutral after half interval
        resetTimeout = setTimeout(() => {
          if (!audio.paused && !audio.ended) {
            applyLogoAnimation(0);
          }
          resetTimeout = null;
        }, halfInterval);
      }

      // Continue animation loop
      animationFrame = requestAnimationFrame(animateLogo);
    }

    window.toggleMusic = function() {
      const audio = document.getElementById('welcomeMusic');
      const logo = document.getElementById('logo');

      if (audio.paused) {
        audio.play();
        logo.classList.add('playing');

        // Start animation loop
        if (animationFrame) {
          cancelAnimationFrame(animationFrame);
        }
        animateLogo();
      } else {
        audio.pause();
        audio.currentTime = 0;
        logo.classList.remove('playing');

        // Stop animation loop
        if (animationFrame) {
          cancelAnimationFrame(animationFrame);
          animationFrame = null;
        }

        // Clear any pending reset
        if (resetTimeout) {
          clearTimeout(resetTimeout);
          resetTimeout = null;
        }

        // Reset to neutral
        animateLogo();
      }
    };

    window.createPit = function() {
      // Generate a random pit slug
      const slug = Math.random().toString(36).substring(2, 10);
      window.location.href = `/pit/${slug}/creator`;
    };

    window.jumpToPit = async function() {
      const code = document.getElementById('pit-code').value.trim();
      if (!code) {
        alert('Please enter a pit code');
        return;
      }

      // Check if pit exists before navigating
      try {
        const response = await fetch(`/pit/${code}`, { method: 'HEAD' });
        if (response.ok) {
          window.location.href = `/pit/${code}/creator`;
        } else {
          alert(`Pit "${code}" does not exist. Check your code or create a new pit.`);
        }
      } catch (err) {
        console.error('Error checking pit existence:', err);
        // If check fails, navigate anyway (fallback)
        window.location.href = `/pit/${code}/creator`;
      }
    };

    window.openQRScanner = async function(event) {
      if (event) {
        event.stopPropagation();
      }

      const modal = document.getElementById('qr-scanner-modal');
      const status = document.getElementById('scanner-status');

      modal.classList.add('active');
      status.textContent = 'Starting camera...';

      try {
        html5QrCode = new Html5Qrcode('qr-reader');

        await html5QrCode.start(
          { facingMode: 'environment' }, // Use back camera
          {
            fps: 10,
            qrbox: { width: 250, height: 250 }
          },
          (decodedText) => {
            // QR code found!
            status.textContent = 'QR Code found!';

            // Extract pit code from URL
            // Supports: /pit/ABC123/creator, /pit/ABC123/viewer, or just ABC123
            let pitCode = null;

            try {
              const url = new URL(decodedText);
              const match = url.pathname.match(/\/pit\/([^\/]+)/);
              if (match) {
                pitCode = match[1];
              }
            } catch {
              // Not a valid URL, maybe just the pit code
              pitCode = decodedText.trim();
            }

            if (pitCode) {
              closeQRScanner();
              window.location.href = `/pit/${pitCode}/creator`;
            } else {
              status.textContent = 'Not a valid SyncPit QR code';
            }
          },
          (errorMessage) => {
            // Scanning (no QR code in view)
            status.textContent = 'Point camera at QR code...';
          }
        );
      } catch (err) {
        console.error('Failed to start QR scanner:', err);
        status.textContent = 'Failed to access camera. Please check permissions.';
      }
    };

    window.closeQRScanner = async function() {
      const modal = document.getElementById('qr-scanner-modal');
      const status = document.getElementById('scanner-status');

      if (html5QrCode) {
        try {
          await html5QrCode.stop();
          html5QrCode = null;
        } catch (err) {
          console.error('Failed to stop QR scanner:', err);
        }
      }

      modal.classList.remove('active');
      status.textContent = 'Point camera at QR code...';
    };

    window.openModal = function() {
      document.getElementById('info-modal').classList.add('active');
    };

    window.closeModal = function() {
      document.getElementById('info-modal').classList.remove('active');
    };

    // Close modals when clicking outside
    document.getElementById('info-modal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeModal();
      }
    });

    document.getElementById('qr-scanner-modal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeQRScanner();
      }
    });

    // Close modals with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeModal();
        closeQRScanner();
      }
    });
  </script>
</body>
</html>
